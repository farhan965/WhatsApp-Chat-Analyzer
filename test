with cte as summarized as 
(

SELECT c.*
      ,sprev.TotalKits AS PriorKits
      ,sprev.Amount AS PriorAmount
FROM combined_full c
LEFT JOIN (
    SELECT *,
           ROW_NUMBER() OVER (PARTITION BY Email ORDER BY first_inst desc) AS rn
    FROM combined_full
) sprev ON c.Email = sprev.Email AND sprev.rn = 1 and sprev.first_inst < c.first_inst
WHERE c.first_inst = 1 
   OR sprev.TotalKits <> c.TotalKits 
   OR sprev.Amount <> c.Amount



)

select * from summarized;




with cte as summarized as 
(

SELECT  c.*
	   ,sprev.TotalKits PriorKits
	   ,sprev.Amount PriorAmount
	  

FROM combined_full c

     OUTER APPLY (SELECT TOP 1 TotalKits, Amount
	               FROM combined_full sprev
	              WHERE sprev.Email = c.Email
				    AND sprev.first_inst < c.first_inst
			      ORDER BY sprev.first_inst	DESC	) sprev

WHERE  c.first_inst = 1 OR sprev.TotalKits <> c.TotalKits OR sprev.Amount <> c.Amount  --<--Grab first available instance OR when values have changed


)

select * from summarized;
